<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="CertificateAuthority.html">CertificateAuthority</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CertificateAuthority.html#issue">issue</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HalfSocket.html">HalfSocket</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HalfSocket.html#emit">emit</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Kernel.html">Kernel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Kernel.html#lookup">lookup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Kernel.html#open">open</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MockSocket.html">MockSocket</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MockTLSServer.html">MockTLSServer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MockTLSServer.html#listen">listen</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Server.html">Server</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Server.html#_checkClosed">_checkClosed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Server.html#close">close</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Server.html#emit">emit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Server.html#getConnections">getConnections</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Server.html#listen">listen</a></span></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="HalfSocket.html#event:written">written</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#connect">connect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createServer">createServer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#extendedError">extendedError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getServer">getServer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#log">log</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#normalizeArgs">normalizeArgs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#select">select</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {log, normalizeArgs, select} from './utils.js'
import {CertificateAuthority} from './ca.js'
import net from './net.js'
import tls from 'tls'

const PRIVATE = new WeakMap()

/**
 * @callback SecureConnectionCallback
 * @param {tls.TLSSocket} sock The server side of the socket that was connected.
 * @returns {void}
 */

/**
 * @typedef {object} ServerOpts
 * @property {CertificateAuthority} [ca] A CA instance to use.  If you are
 *   creating lots of servers, create one CA to pass into each of them, so
 *   that certs don't need to be created from scratch for each.
 * @property {SecureConnectionCallback} [secureConnectionListener] Installed
 *   as a listener for the 'secureConnection' event.
 * @property {Date} [notafter='Now + 5m'] Certificate not valid after this
 *   date.
 * @property {Date} [notbefore='Now - 1s'] Certificate not valid before this
 *   date.
 * @property {string} [subject] Subject Distinguished Name (DN).
 * @property {string[]} [names=['localhost']] DNS Subject Alternative Names
 *   for the cert.  Ignored for the CA cert.
 * @property {boolean} [allowHalfOpen=false] If set to false, then the
 *   socket will automatically end the writable side when the readable side
 *   ends.
 */

/**
 * A TLS server that mocks the network, but all of the crypto code is real.
 */
export class MockTLSServer extends net.Server {
  /**
   * Create a MockTLSServer instance.
   *
   * @param {ServerOpts|SecureConnectionCallback} [options] Server options.
   * @param {SecureConnectionCallback} [secureConnectionListener] Installed as
   *   a listener for the 'secureConnection' event.
   */
  constructor(options, secureConnectionListener) {
    const opts = normalizeArgs(options, {secureConnectionListener})
    const [local_opts, cert_opts, socket_opts] = select(
      opts,
      ['ca', 'secureConnectionListener'],
      ['notafter', 'notbefore', 'subject', 'names']
    )

    super(socket_opts, sock => {
      // Turn connection into TLS sock and call secureConnectionListener
      // @ts-ignore TS2345: Duplex should be allowed.
      const tsock = new tls.TLSSocket(sock, {
        isServer: true,
        requestCert: false,
        cert: this.cert,
        key: PRIVATE.get(this),
      })
      const temit = tsock.emit
      tsock.emit = (eventName, ...args) => {
        log('tls', eventName, ...args.map(
          o => ((typeof o === 'object') ? o.constructor.name || o.toString() : o)
        ))
        return temit.call(tsock, eventName, ...args)
      }
      tsock.on('secure', () => {
        process.nextTick(() => this.emit('secureConnection', tsock))
      })
    })

    /** @type {CertificateAuthority} */
    this.ca = local_opts.ca || new CertificateAuthority()
    const serverProps = this.ca.issue(cert_opts)

    /** @type {string} */
    this.cert = serverProps.cert
    PRIVATE.set(this, serverProps.key)

    if (local_opts.secureConnectionListener) {
      this.on('secureConnection', local_opts.secureConnectionListener)
    }
    // Create a real TLSSocket for each connection.
  }

  /**
   * @typedef {object} ListenOptions
   * @property {number} port The port to listen on.
   * @property {Function} secureConnectionListener If it exists, installed as
   *   a listener for the 'secureConnection' event.
   */

  /**
   * Listen for incoming connections.  Whenever `connect` is called on this
   * server's port, create a mock socket wrapped in a TLSSocket.
   *
   * @param {number|ListenOptions} [options] Port number or options object.
   * @param {Function} [secureConnectionListener] If it exists, installed as
   *   a listener for the 'secureConnection' event.
   * @returns {MockTLSServer} This.
   */
  // @ts-ignore TS2416: This is compatible-enough with the base class.
  listen(options, secureConnectionListener) {
    const opts = normalizeArgs(options, {secureConnectionListener})

    if (opts.secureConnectionListener) {
      this.on('secureConnection', opts.secureConnectionListener)
    }
    super.listen(opts.port)
    return this
  }
}

/**
 * @typedef {object} SocketConnectOpts
 * @property {number} port Listening server port to connect to.
 * @property {boolean} [allowHalfOpen=false] If set to false, then the
 *   socket will automatically end the writable side when the readable side
 *   ends.
 */

/**
 * Create a client connection to a listening server.
 *
 * @param {SocketConnectOpts|number} options Port to connect to.
 * @param {Function} [secureConnectListener] If specified, function is
 *   registered for the 'secureConnect'.
 * @returns {tls.TLSSocket} Socket.
 */
export function connect(options, secureConnectListener) {
  const {port, secureConnectListener: scl, ...opts} =
    normalizeArgs(options, {secureConnectListener})

  opts.socket = net.connect(port) // Emits error if connection failed
  const srv = net.getServer(port)
  if (srv &amp;&amp; (srv instanceof MockTLSServer)) {
    opts.ca = srv.ca.cert_pem
  }

  const secureSocket = tls.connect(opts)
  if (scl) {
    secureSocket.on('secure', scl)
  }
  return secureSocket
}

export const plainConnect = net.connect
export default {
  MockTLSServer,
  connect,
  plainConnect,
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
